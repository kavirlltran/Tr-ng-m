<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Advanced Pronunciation Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Nền trang sử dụng ảnh maytinh.png */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: url('maytinh.png') no-repeat center center fixed;
      background-size: cover;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: rgba(0, 0, 0, 0.6); /* Thay đổi background cho phù hợp tone màu */
      color: #fff; /* Chữ màu trắng để tương phản */
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    p {
      text-align: center;
    }
    .line-card {
      position: relative;
      background: rgba(255,255,255,0.9);
      color: #000;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
    }
    .line-card:hover, .line-card.active {
      transform: translateY(-3px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.3);
      border: 2px solid #2196F3;
      background-color: #f7f7f7;
      color: #000;
    }
    .line-text {
      font-size: 1.2rem;
      line-height: 1.5;
    }
    .controls {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background-color: #e0e0e0;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }
    button:hover {
      background-color: #d5d5d5;
    }
    #evaluation {
      margin-top: 1rem;
      background: #f1f1f1;
      color: #000;
      padding: 0.8rem;
      border-radius: 4px;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    #evaluation span.error {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Advanced Pronunciation Checker</h1>
    <p>
      Select a sentence to practice and then use the button below to record your pronunciation.
      When you stop recording, the evaluation result for the selected sentence will be displayed below.
    </p>
    
    <!-- Danh sách 5 câu nội dung -->
    <div class="line-card" data-line="1">
      <div class="line-text">We should ‘finish the ‘project for our ‘history ‘class</div>
    </div>
    
    <div class="line-card" data-line="2">
      <div class="line-text">‘Peter is re‘vising for his e‘xam ‘next ‘week.</div>
    </div>
    
    <div class="line-card" data-line="3">
      <div class="line-text">‘Students will ‘spend more ‘time ‘working with ‘other ‘classmates.</div>
    </div>
    
    <div class="line-card" data-line="4">
      <div class="line-text">I ‘like to ‘watch ‘videos that ‘help me ‘learn ‘new ‘things</div>
    </div>
    
    <div class="line-card" data-line="5">
      <div class="line-text">I have ‘installed some ‘apps on my ‘phone</div>
    </div>
    
    <!-- Nút ghi âm (toggle: start/stop) -->
    <div class="controls">
      <button id="toggleBtn" disabled style="color: blue;">Start Recording</button>
    </div>
    
    <!-- Khu vực hiển thị kết quả đánh giá -->
    <div id="evaluation">
      <strong>Evaluation Result:</strong> <span id="evalContent">Please select a sentence and record.</span>
    </div>
  </div>

  <script>
    // ======= Các biến toàn cục =======
    let selectedLineCard = null;
    let selectedLineText = "";
    let recognition;
    let isRecording = false;
    let recordStartTime, recordEndTime;

    // Các biến để đo âm lượng qua AudioContext
    let audioContext, analyser, dataArray, mediaStream;
    let volumeSum = 0, volumeCount = 0;
    let volumeMonitorId = null;

    // Hàm khởi tạo lại SpeechRecognition sau mỗi lần ghi âm
    function initSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("Your browser does not support Speech Recognition. Please use Chrome or a compatible browser.");
        return null;
      }
      let recog = new SpeechRecognition();
      recog.lang = "en-US";
      recog.interimResults = false;
      recog.maxAlternatives = 1;
      
      recog.addEventListener('start', () => {
        console.log("Speech recognition started.");
      });
      
      recog.addEventListener('result', (event) => {
        const transcript = event.results[0][0].transcript;
        console.log("Recognized:", transcript);
        recordEndTime = Date.now();
        evaluatePronunciation(selectedLineText, transcript);
      });
      
      recog.addEventListener('end', () => {
        console.log("Speech recognition ended.");
      });
      
      recog.addEventListener('error', (e) => {
        console.error("Speech recognition error:", e.error);
      });
      return recog;
    }

    // ===== Yêu cầu truy cập Micro khi tải trang =====
    async function initMicrophone() {
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        // Khởi tạo AudioContext để đo âm lượng
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(mediaStream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        source.connect(analyser);
        console.log("Microphone and AudioContext initialized.");
        // Cho phép nút ghi âm
        document.getElementById("toggleBtn").disabled = false;
      } catch (err) {
        alert("Error accessing microphone: " + err);
      }
    }
    window.addEventListener("load", initMicrophone);

    // ===== Xử lý sự kiện chọn dòng =====
    const lineCards = document.querySelectorAll(".line-card");
    lineCards.forEach(card => {
      card.addEventListener("click", () => {
        // Loại bỏ active của tất cả các card
        lineCards.forEach(c => c.classList.remove("active"));
        card.classList.add("active");
        selectedLineCard = card;
        selectedLineText = card.querySelector(".line-text").textContent.trim();
        console.log("Selected sentence:", selectedLineText);
        document.getElementById("evalContent").textContent = "Ready to record the selected sentence.";
      });
    });

    // ===== Quản lý ghi âm với nút toggle =====
    const toggleBtn = document.getElementById("toggleBtn");
    toggleBtn.addEventListener("click", () => {
      // Nếu chưa có câu nào được chọn, tự động chọn câu đầu tiên
      if (!selectedLineText) {
        const firstCard = document.querySelector(".line-card");
        if (firstCard) {
          firstCard.classList.add("active");
          selectedLineCard = firstCard;
          selectedLineText = firstCard.querySelector(".line-text").textContent.trim();
          console.log("Auto-selected sentence:", selectedLineText);
        }
      }
      if (!isRecording) {
        // Bắt đầu ghi âm
        isRecording = true;
        recordStartTime = Date.now();
        // Reset dữ liệu âm lượng
        volumeSum = 0;
        volumeCount = 0;
        startVolumeMonitoring();
        // Khởi tạo lại SpeechRecognition cho mỗi phiên ghi âm
        recognition = initSpeechRecognition();
        if (recognition) {
          recognition.start();
          toggleBtn.textContent = "Stop Recording";
          toggleBtn.style.color = "red"; // Khi đang ghi âm -> màu đỏ
          console.log("Recording started...");
        } else {
          isRecording = false;
        }
      } else {
        // Dừng ghi âm
        isRecording = false;
        stopVolumeMonitoring();
        if(recognition) {
          recognition.stop();
        }
        toggleBtn.textContent = "Start Recording";
        toggleBtn.style.color = "blue"; // Khi chưa ghi âm -> màu xanh
        console.log("Recording stopped.");
      }
    });

    // ===== Hàm theo dõi âm lượng =====
    function startVolumeMonitoring() {
      function monitor() {
        if (!isRecording) return;
        analyser.getByteTimeDomainData(dataArray);
        // Tính RMS (gốc bình phương trung bình) của tín hiệu
        let sumSquares = 0;
        for (let i = 0; i < dataArray.length; i++) {
          const normalized = (dataArray[i] - 128) / 128;
          sumSquares += normalized * normalized;
        }
        const rms = Math.sqrt(sumSquares / dataArray.length);
        volumeSum += rms;
        volumeCount++;
        volumeMonitorId = requestAnimationFrame(monitor);
      }
      monitor();
    }
    function stopVolumeMonitoring() {
      if (volumeMonitorId) {
        cancelAnimationFrame(volumeMonitorId);
        volumeMonitorId = null;
      }
    }

    // ===== Hàm đánh giá phát âm =====
    function evaluatePronunciation(original, transcript) {
      // Loại bỏ dấu câu khỏi nội dung gốc
      const cleanOriginal = original.replace(/[.,?!]/g, "");
      const originalWords = cleanOriginal.split(/\s+/);
      const transcriptWords = transcript.split(/\s+/);
  
      let correctCount = 0;
      let resultHTML = "";
      originalWords.forEach((word, idx) => {
        // Loại bỏ ký tự trọng âm khỏi từ gốc
        const normalizedOriginal = word.replace(/['‘’]/g, "").toLowerCase();
        const transcriptWord = transcriptWords[idx] ? transcriptWords[idx].toLowerCase() : "";
        if (normalizedOriginal === transcriptWord) {
          resultHTML += word + " ";
          correctCount++;
        } else {
          resultHTML += `<span class="error">${word}</span> `;
        }
      });
      const wordAccuracy = Math.round((correctCount / originalWords.length) * 100);

      // ===== Đánh giá âm lượng =====
      const avgVolume = volumeCount ? volumeSum / volumeCount : 0;
      let volumeScore = Math.min(100, Math.round((avgVolume / 0.15) * 100));
      if (volumeScore > 100) volumeScore = 100;

      // ===== Đánh giá tốc độ đọc =====
      const durationSec = (recordEndTime - recordStartTime) / 1000;
      const wpm = Math.round((originalWords.length / durationSec) * 60);
      let speedScore = Math.max(0, 100 - Math.abs(150 - wpm));
  
      // Hiển thị kết quả đánh giá trong 1 ô duy nhất bên dưới danh sách câu
      document.getElementById("evalContent").innerHTML = `
        <strong>Word Accuracy:</strong> ${wordAccuracy}% (${correctCount}/${originalWords.length})<br>
        <strong>Transcript:</strong> ${resultHTML}<br>
        <strong>Volume Score:</strong> ${volumeScore} / 100<br>
        <strong>Speed Score:</strong> ${speedScore} / 100 (Your speed: ${wpm} wpm, ideal: ~150 wpm)
      `;
    }
  </script>
</body>
</html>
